name: Build QuakeC

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "quakec/**"
      - ".github/workflows/build-quakec.yml"
  pull_request:
    branches: [ main ]
    paths:
      - "quakec/**"
      - ".github/workflows/build-quakec.yml"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify compiler exists
        shell: pwsh
        run: |
          if (!(Test-Path "quakec/fteqcc64.exe")) {
            throw "Compiler not found at quakec/fteqcc64.exe"
          }
          Write-Host "Found quakec/fteqcc64.exe"

      - name: Compile QuakeC mod
        shell: pwsh
        run: |
          Push-Location quakec
          .\fteqcc64.exe
          Pop-Location

      - name: Verify output
        shell: pwsh
        run: |
          $out = "Game/cortex/progs.dat"
          if (!(Test-Path $out)) {
            throw "Build failed - progs.dat not found at $out"
          }

          $size = (Get-Item $out).Length
          if ($size -lt 100000) {
            throw "Build failed - progs.dat unexpectedly small ($size bytes)"
          }

          Write-Host "Build successful: $out ($size bytes)"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: progs-dat
          path: Game/cortex/progs.dat
          retention-days: 30
